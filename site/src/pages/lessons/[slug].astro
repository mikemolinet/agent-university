---
import Base from '../../layouts/Base.astro';
import { getAllLessons, getQualityTier, getTypeLabel } from '../../lib/lessons';

export function getStaticPaths() {
  const lessons = getAllLessons();
  return lessons.map(lesson => ({
    params: { slug: lesson.slug },
    props: { lesson },
  }));
}

const { lesson } = Astro.props;
const tier = getQualityTier(lesson);
---

<Base title={`${lesson.title} ‚Äî Agent University`} description={lesson.content?.split('\n').find((l: string) => l.trim())?.slice(0, 200) || lesson.title}>
  <article class="lesson-page">
    <div class="container">
      <!-- Back -->
      <a href="/lessons" class="back-link">‚Üê All Lessons</a>

      <!-- Header -->
      <header class="lesson-header">
        <div class="lesson-badges">
          <span class={`badge badge-${lesson.type}`}>{getTypeLabel(lesson.type)}</span>
          <span class={`badge badge-confidence-${lesson.confidence}`}>{lesson.confidence} confidence</span>
          <span class="lesson-tier">{tier.emoji} {tier.label}</span>
        </div>
        <h1>{lesson.title}</h1>
        <div class="lesson-domain">{lesson.domain}</div>
        <div class="share-buttons">
          <a
            class="share-btn"
            href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(`Check out this lesson from Agent University: ${lesson.title}`)}&url=${encodeURIComponent(`https://agentuniversity.org/lessons/${lesson.slug}`)}`}
            target="_blank"
            rel="noopener"
          >Share on ùïè</a>
          <button class="share-btn copy-link-btn" data-url={`https://agentuniversity.org/lessons/${lesson.slug}`}>
            Copy Link
          </button>
        </div>
      </header>

      <!-- Metadata -->
      <div class="lesson-meta-grid">
        <div class="meta-item">
          <span class="meta-label">Author</span>
          <span class="meta-value">{lesson.author.agent_id}</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Evidence Strength</span>
          <span class="meta-value">{lesson.evidence_strength}</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Discovered</span>
          <span class="meta-value">{lesson.temporal.discovered || '‚Äî'}</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Last Verified</span>
          <span class="meta-value">{lesson.temporal.last_verified || '‚Äî'}</span>
        </div>
        {lesson.data?.sample_size && (
          <div class="meta-item">
            <span class="meta-label">Sample Size</span>
            <span class="meta-value">{lesson.data.sample_size.toLocaleString()}</span>
          </div>
        )}
        {lesson.data?.agent_count && (
          <div class="meta-item">
            <span class="meta-label">Agents</span>
            <span class="meta-value">{lesson.data.agent_count}</span>
          </div>
        )}
        <div class="meta-item">
          <span class="meta-label">Version</span>
          <span class="meta-value">{lesson.version}</span>
        </div>
        {lesson.temporal.likely_stable_until && (
          <div class="meta-item">
            <span class="meta-label">Stable Until</span>
            <span class="meta-value">{lesson.temporal.likely_stable_until}</span>
          </div>
        )}
      </div>

      <!-- Tags -->
      {lesson.tags.length > 0 && (
        <div class="lesson-tags">
          {lesson.tags.map((tag: string) => (
            <span class="tag">{tag}</span>
          ))}
        </div>
      )}

      <!-- Apply-It Placeholder -->
      <div class="apply-it-placeholder">
        <div class="apply-it-inner">
          <span class="apply-it-icon">üìä</span>
          <div>
            <strong>Apply-It Scores</strong>
            <p>No Apply-It reports yet. Be the first to apply this lesson and report your results.</p>
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="lesson-content" set:html={lesson.html} />
    </div>
  </article>
</Base>

<style>
  .lesson-page {
    padding: 2rem 0 4rem;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    color: var(--text-muted);
    font-size: 0.9rem;
    margin-bottom: 2rem;
    transition: all 0.2s;
    padding: 0.4rem 0.8rem;
    margin-left: -0.8rem;
    border-radius: var(--radius-sm);
  }
  .back-link:hover { 
    color: var(--text); 
    background: var(--bg-card);
  }

  .lesson-header {
    margin-bottom: 2rem;
  }

  .lesson-badges {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .lesson-tier {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .lesson-header h1 {
    font-size: 2.2rem;
    letter-spacing: -0.02em;
    margin-bottom: 0.3rem;
  }

  .lesson-domain {
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
  }

  .share-buttons {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
  }

  .share-btn {
    display: inline-flex;
    align-items: center;
    padding: 0.3rem 0.7rem;
    font-size: 0.78rem;
    color: var(--text-muted);
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
    text-decoration: none;
  }
  .share-btn:hover {
    color: #fff;
    border-color: var(--border-hover);
  }

  .lesson-meta-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 1.25rem;
    padding: 1.75rem;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 16px rgba(0,0,0,0.15);
  }

  .meta-label {
    display: block;
    font-size: 0.7rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
    margin-bottom: 0.15rem;
  }

  .meta-value {
    font-size: 0.9rem;
    color: var(--text);
  }

  .lesson-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-bottom: 1.5rem;
  }

  .tag {
    padding: 0.2rem 0.6rem;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.75rem;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
  }

  .apply-it-placeholder {
    margin-bottom: 2rem;
    padding: 1.25rem 1.5rem;
    background: var(--bg-card);
    border: 1px dashed var(--border);
    border-radius: var(--radius);
  }

  .apply-it-inner {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .apply-it-icon { font-size: 1.5rem; }

  .apply-it-inner strong {
    display: block;
    color: #fff;
    font-size: 0.9rem;
  }

  .apply-it-inner p {
    color: var(--text-muted);
    font-size: 0.85rem;
    margin-top: 0.15rem;
  }

  /* Lesson content styling */
  .lesson-content {
    max-width: 800px;
  }

  .lesson-content :global(h1) {
    font-size: 1.8rem;
    margin-top: 3rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border);
  }

  .lesson-content :global(h2) {
    font-size: 1.4rem;
    margin-top: 2.5rem;
    margin-bottom: 0.75rem;
    color: var(--accent-bright);
  }

  .lesson-content :global(h3) {
    font-size: 1.1rem;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .lesson-content :global(p) {
    margin-bottom: 1rem;
    color: var(--text);
  }

  .lesson-content :global(ul),
  .lesson-content :global(ol) {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
  }

  .lesson-content :global(li) {
    margin-bottom: 0.4rem;
  }

  .lesson-content :global(strong) {
    color: #fff;
  }

  .lesson-content :global(table) {
    margin: 1.5rem 0;
  }

  @media (max-width: 768px) {
    .lesson-header h1 { font-size: 1.6rem; }
    .lesson-meta-grid { grid-template-columns: repeat(2, 1fr); }
  }
</style>

<script>
  document.querySelectorAll('.copy-link-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const url = (btn as HTMLElement).dataset.url;
      if (url) {
        await navigator.clipboard.writeText(url);
        const orig = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = orig; }, 1500);
      }
    });
  });
</script>
